"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getGlobalContextSync = getGlobalContextSync;
exports.getGlobalContextAsync = getGlobalContextAsync;
exports.getGlobalContext = getGlobalContext;
exports.getViteDevServer = getViteDevServer;
exports.getViteConfig = getViteConfig;
exports.getRuntimeManifest = getRuntimeManifest;
exports.initGlobalContext_renderPage = initGlobalContext_renderPage;
exports.initGlobalContext_runPrerender = initGlobalContext_runPrerender;
exports.initGlobalContext_getGlobalContextAsync = initGlobalContext_getGlobalContextAsync;
exports.setGlobalContext_viteDevServer = setGlobalContext_viteDevServer;
exports.setGlobalContext_viteConfig = setGlobalContext_viteConfig;
exports.setGlobalContext_isDev = setGlobalContext_isDev;
exports.setGlobalContext_isPrerendering = setGlobalContext_isPrerendering;
const utils_js_1 = require("./utils.js");
const loadImportBuild_js_1 = require("./globalContext/loadImportBuild.js");
const getPageFiles_js_1 = require("../../shared/getPageFiles.js");
const assertPluginManifest_js_1 = require("../shared/assertPluginManifest.js");
const getConfigVike_js_1 = require("../shared/getConfigVike.js");
const assertRuntimeManifest_js_1 = require("../shared/assertRuntimeManifest.js");
const picocolors_1 = __importDefault(require("@brillout/picocolors"));
const getPageFilesExports_js_1 = require("./page-files/getPageFilesExports.js");
const globalObject = (0, utils_js_1.getGlobalObject)('globalContext.ts', (() => {
    const { promise: viteDevServerPromise, resolve: viteDevServerPromiseResolve } = (0, utils_js_1.genPromise)();
    return {
        viteDevServerPromise,
        viteDevServerPromiseResolve
    };
})());
function getGlobalContext() {
    (0, utils_js_1.assert)(globalObject.globalContext);
    return globalObject.globalContext;
}
/** @experimental https://vike.dev/getGlobalContext */
function getGlobalContextSync() {
    (0, utils_js_1.assertUsage)(globalObject.globalContext, "The global context isn't set yet, call getGlobalContextSync() later or use getGlobalContextAsync() instead.");
    return makePublic(globalObject.globalContext);
}
/** @experimental https://vike.dev/getGlobalContext */
async function getGlobalContextAsync(isProduction) {
    (0, utils_js_1.assertUsage)(typeof isProduction === 'boolean', `[getGlobalContextAsync(isProduction)] Argument ${picocolors_1.default.cyan('isProduction')} ${isProduction === undefined ? 'is missing' : `should be ${picocolors_1.default.cyan('true')} or ${picocolors_1.default.cyan('false')}`}`);
    await initGlobalContext_getGlobalContextAsync(isProduction);
    const { globalContext } = globalObject;
    (0, utils_js_1.assert)(globalContext);
    return makePublic(globalContext);
}
function makePublic(globalContext) {
    const globalContextPublic = {
        assetsManifest: globalContext.assetsManifest
    };
    // Add internals (and prepended _ prefix to their keys)
    {
        const publicKeys = Object.keys(globalContextPublic);
        (0, utils_js_1.objectKeys)(globalContext)
            .filter((key) => !publicKeys.includes(key))
            .forEach((key) => {
            const keyPublic = `_${key}`;
            Object.defineProperty(globalContextPublic, keyPublic, {
                enumerable: true,
                get() {
                    (0, utils_js_1.assertWarning)(false, `Using internal globalContext.${keyPublic} which is discouraged: it may break in any minor version update. Instead, reach out on GitHub and elaborate your use case.`, {
                        onlyOnce: true
                    });
                    return globalContext[key];
                }
            });
        });
    }
    return globalContextPublic;
}
function setGlobalContext_viteDevServer(viteDevServer) {
    if (globalObject.viteDevServer)
        return;
    assertIsNotInitilizedYet();
    (0, utils_js_1.assert)(globalObject.viteConfig);
    globalObject.viteDevServer = viteDevServer;
    globalObject.viteDevServerPromiseResolve(viteDevServer);
    eagerlyLoadUserFiles();
}
function setGlobalContext_viteConfig(viteConfig, outDirRoot) {
    if (globalObject.viteConfig)
        return;
    assertIsNotInitilizedYet();
    globalObject.viteConfig = viteConfig;
    globalObject.outDirRoot = outDirRoot;
}
function assertIsNotInitilizedYet() {
    // In develpoment, globalObject.viteDevServer always needs to be awaited for before initializing globalObject.globalContext
    (0, utils_js_1.assert)(!globalObject.globalContext);
}
function setGlobalContext_isDev(isDev) {
    globalObject.isDev = isDev;
}
function setGlobalContext_isPrerendering() {
    globalObject.isPrerendering = true;
}
function getViteDevServer() {
    return globalObject.viteDevServer ?? null;
}
function getViteConfig() {
    return globalObject.viteConfig ?? null;
}
async function initGlobalContext_renderPage() {
    await initGlobalContext(!globalObject.isDev);
}
async function initGlobalContext_runPrerender() {
    if (globalObject.initGlobalContext_runPrerender_alreadyCalled)
        return;
    globalObject.initGlobalContext_runPrerender_alreadyCalled = true;
    (0, utils_js_1.assert)(globalObject.isPrerendering);
    (0, utils_js_1.assert)(globalObject.viteConfig);
    (0, utils_js_1.assert)(globalObject.outDirRoot);
    // We assume initGlobalContext_runPrerender() to be called before:
    // - initGlobalContext_renderPage()
    // - initGlobalContext_getGlobalContextAsync()
    (0, utils_js_1.assert)(!globalObject.globalContext);
    await initGlobalContext(true);
}
async function initGlobalContext_getGlobalContextAsync(isProduction) {
    if (!isProduction) {
        const waitFor = 20;
        const timeout = setTimeout(() => {
            (0, utils_js_1.assertWarning)(false, `Vite's development server still not created after ${waitFor} seconds.`, {
                onlyOnce: false,
                showStackTrace: true
            });
        }, waitFor * 1000);
        await globalObject.viteDevServerPromise;
        clearTimeout(timeout);
    }
    await initGlobalContext(isProduction);
}
async function initGlobalContext(isProduction) {
    if (globalObject.globalContext) {
        (0, utils_js_1.assert)(globalObject.globalContext.isProduction === isProduction);
        // We assume setGlobalContext_isPrerendering() is called before initGlobalContext()
        (0, utils_js_1.assert)(globalObject.globalContext.isPrerendering === (globalObject.isPrerendering ?? false));
        return;
    }
    const { viteDevServer, viteConfig, isDev, isPrerendering } = globalObject;
    (0, utils_js_1.assertNodeEnv_runtime)(isDev ?? false);
    if (!isProduction) {
        (0, utils_js_1.assert)(viteConfig);
        (0, utils_js_1.assert)(viteDevServer);
        (0, utils_js_1.assert)(!isPrerendering);
        const configVike = await (0, getConfigVike_js_1.getConfigVike)(viteConfig);
        const pluginManifest = getRuntimeManifest(configVike);
        globalObject.globalContext = {
            isProduction: false,
            isPrerendering: false,
            assetsManifest: null,
            pluginManifest: null,
            viteDevServer,
            viteConfig,
            baseServer: pluginManifest.baseServer,
            baseAssets: pluginManifest.baseAssets,
            includeAssetsImportedByServer: pluginManifest.includeAssetsImportedByServer,
            redirects: pluginManifest.redirects,
            trailingSlash: pluginManifest.trailingSlash,
            disableUrlNormalization: pluginManifest.disableUrlNormalization
        };
    }
    else {
        const buildEntries = await (0, loadImportBuild_js_1.loadImportBuild)(globalObject.outDirRoot);
        assertBuildEntries(buildEntries, isPrerendering ?? false);
        const { pageFiles, assetsManifest, pluginManifest } = buildEntries;
        (0, getPageFiles_js_1.setPageFiles)(pageFiles);
        assertViteManifest(assetsManifest);
        (0, assertPluginManifest_js_1.assertPluginManifest)(pluginManifest);
        const globalContext = {
            isProduction: true,
            assetsManifest,
            pluginManifest,
            viteDevServer: null,
            baseServer: pluginManifest.baseServer,
            baseAssets: pluginManifest.baseAssets,
            includeAssetsImportedByServer: pluginManifest.includeAssetsImportedByServer,
            redirects: pluginManifest.redirects,
            trailingSlash: pluginManifest.trailingSlash,
            disableUrlNormalization: pluginManifest.disableUrlNormalization
        };
        if (isPrerendering) {
            (0, utils_js_1.assert)(viteConfig);
            const configVike = await (0, getConfigVike_js_1.getConfigVike)(viteConfig);
            (0, utils_js_1.assert)(configVike);
            (0, utils_js_1.objectAssign)(globalContext, {
                isPrerendering: true,
                viteConfig
            });
            globalObject.globalContext = globalContext;
        }
        else {
            (0, utils_js_1.objectAssign)(globalContext, {
                isPrerendering: false,
                viteConfig: null
            });
            globalObject.globalContext = globalContext;
        }
    }
}
function getRuntimeManifest(configVike) {
    const { includeAssetsImportedByServer, baseServer, baseAssets, redirects, trailingSlash, disableUrlNormalization } = configVike;
    const manifest = {
        baseServer,
        baseAssets,
        includeAssetsImportedByServer,
        redirects,
        trailingSlash,
        disableUrlNormalization
    };
    (0, assertRuntimeManifest_js_1.assertRuntimeManifest)(manifest);
    return manifest;
}
function assertBuildEntries(buildEntries, isPreRendering) {
    const errMsg = [
        `You are tyring to run`,
        isPreRendering ? 'pre-rendering' : 'the server for production',
        `but your app isn't built yet. Run ${picocolors_1.default.cyan('$ vite build')} before `,
        isPreRendering ? 'pre-rendering.' : 'running the server.'
    ].join(' ');
    (0, utils_js_1.assertUsage)(buildEntries, errMsg);
}
function assertViteManifest(manifest) {
    (0, utils_js_1.assert)((0, utils_js_1.isPlainObject)(manifest));
    /* We should include these assertions but we don't as a workaround for PWA manifests: https://github.com/vikejs/vike/issues/769
       Instead, we should rename the vite manifest e.g. with https://vitejs.dev/config/build-options.html#build-manifest
    Object.entries(manifest)
      // circumvent esbuild bug: esbuild adds a `default` key to JSON upon `require('./some.json')`.
      .filter(([key]) => key !== 'default')
      .forEach(([_, entry]) => {
        assert(isPlainObject(entry))
        assert(typeof entry.file === 'string')
      })
    */
}
function eagerlyLoadUserFiles() {
    // Other than here, the getPageFilesExports() function is only called only upon calling the renderPage() function.
    // We call it as early as possible here for better performance.
    (0, getPageFilesExports_js_1.getPageFilesExports)();
}
