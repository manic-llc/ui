"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveClientEntriesDev = resolveClientEntriesDev;
const utils_js_1 = require("./utils.js");
const module_1 = require("module");
const path_1 = require("path");
const url_1 = require("url");
// @ts-ignore Shimmed by dist-cjs-fixup.js for CJS build.
const importMetaUrl = `file://${__filename}`;
const require_ = (0, module_1.createRequire)(importMetaUrl);
const __dirname_ = (0, path_1.dirname)((0, url_1.fileURLToPath)(importMetaUrl));
(0, utils_js_1.assertIsNotProductionRuntime)();
async function resolveClientEntriesDev(clientEntry, viteDevServer) {
    let root = viteDevServer.config.root;
    (0, utils_js_1.assert)(root);
    root = (0, utils_js_1.toPosixPath)(root);
    // The `?import` suffix is needed for MDX to be transpiled:
    //   - Not transpiled: `/pages/markdown.page.mdx`
    //   - Transpiled: `/pages/markdown.page.mdx?import`
    // But `?import` doesn't work with `/@fs/`:
    //   - Not transpiled: /@fs/home/runner/work/vike/vike/examples/react-full/pages/markdown.page.mdx
    //   - Not transpiled: /@fs/home/runner/work/vike/vike/examples/react-full/pages/markdown.page.mdx?import
    if (clientEntry.endsWith('?import')) {
        (0, utils_js_1.assert)(clientEntry.startsWith('/'));
        return clientEntry;
    }
    (0, utils_js_1.assertPosixPath)(clientEntry);
    let filePath;
    if (clientEntry.startsWith('/')) {
        filePath = (0, utils_js_1.pathJoin)(root, clientEntry);
    }
    else {
        if (clientEntry.startsWith('@@vike/')) {
            (0, utils_js_1.assert)(clientEntry.endsWith('.js'));
            try {
                // For Vitest (which doesn't resolve vike to its dist but to its source files)
                // [RELATIVE_PATH_FROM_DIST] Current file: node_modules/vike/node/plugin/resolveClientEntriesDev.js
                filePath = (0, utils_js_1.toPosixPath)(require_.resolve(clientEntry.replace('@@vike/dist/esm/client/', '../../client/').replace('.js', '.ts')));
            }
            catch {
                // For users
                // [RELATIVE_PATH_FROM_DIST] Current file: node_modules/vike/dist/esm/node/plugin/resolveClientEntriesDev.js
                filePath = (0, utils_js_1.toPosixPath)(require_.resolve(clientEntry.replace('@@vike/dist/esm/client/', '../../../../dist/esm/client/')));
            }
        }
        else {
            (0, utils_js_1.assertIsNpmPackageImport)(clientEntry);
            filePath = require_.resolve(clientEntry);
        }
    }
    if (!filePath.startsWith('/')) {
        (0, utils_js_1.assert)(process.platform === 'win32');
        filePath = '/' + filePath;
    }
    filePath = '/@fs' + filePath;
    (0, utils_js_1.assertPosixPath)(filePath);
    return filePath;
}
